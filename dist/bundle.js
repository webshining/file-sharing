"use strict";var ze=Object.create;var D=Object.defineProperty,qe=Object.defineProperties,ue=Object.getOwnPropertyDescriptor,Je=Object.getOwnPropertyDescriptors,$e=Object.getOwnPropertyNames,ae=Object.getOwnPropertySymbols,Ke=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty,Xe=Object.prototype.propertyIsEnumerable;var ce=(r,e,t)=>e in r?D(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,O=(r,e)=>{for(var t in e||={})pe.call(e,t)&&ce(r,t,e[t]);if(ae)for(var t of ae(e))Xe.call(e,t)&&ce(r,t,e[t]);return r},I=(r,e)=>qe(r,Je(e));var Qe=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of $e(e))!pe.call(r,s)&&s!==t&&D(r,s,{get:()=>e[s],enumerable:!(o=ue(e,s))||o.enumerable});return r};var _=(r,e,t)=>(t=r!=null?ze(Ke(r)):{},Qe(e||!r||!r.__esModule?D(t,"default",{value:r,enumerable:!0}):t,r));var c=(r,e,t,o)=>{for(var s=o>1?void 0:o?ue(e,t):e,i=r.length-1,u;i>=0;i--)(u=r[i])&&(s=(o?u(e,t,s):u(s))||s);return o&&s&&D(e,t,s),s};var n=(r,e,t)=>new Promise((o,s)=>{var i=a=>{try{m(t.next(a))}catch(E){s(E)}},u=a=>{try{m(t.throw(a))}catch(E){s(E)}},m=a=>a.done?o(a.value):Promise.resolve(a.value).then(i,u);m((t=t.apply(r,e)).next())});var He=_(require("cookie-parser")),Ae=_(require("cors")),ne=_(require("express")),We=_(require("http")),cr=require("reflect-metadata");var le=_(require("dotenv")),me=_(require("path"));le.default.config();var j=process.env.PORT||7e3,tt=me.default.resolve(),C=process.env.DB_NAME||"database",H=process.env.DB_USER,A=process.env.DB_PASS,W=Number(process.env.DB_PORT),F=process.env.DB_HOST,de=process.env.LOGGING==="true",ge=String(process.env.REDIS_URI),M=process.env.JWT_ACCESS_SECRET||"secret_access_key",z=process.env.JWT_REFRESH_SECRET||"secret_refresh_key",he=Number(process.env.JWT_ACCESS_MINUTES)||30,S=Number(process.env.JWT_REFRESH_MINUTES)||60*3,q=String(process.env.GOOGLE_CLIENT_ID),fe=String(process.env.GOOGLE_CLIENT_SECRET),L=["https://www.googleapis.com/auth/userinfo.email","https://www.googleapis.com/auth/userinfo.profile"],Ee="https://accounts.google.com/o/oauth2/v2/auth",_e="https://oauth2.googleapis.com/token",J=String(process.env.GOOGLE_REDIRECT_URI),Se="https://www.googleapis.com/oauth2/v2/userinfo",$=String(process.env.GITHUB_CLIENT_ID),ye=String(process.env.GITHUB_CLIENT_SECRET);var Re="https://github.com/login/oauth/authorize",Te="https://github.com/login/oauth/access_token",K=String(process.env.GITHUB_REDIRECT_URI),Oe="https://api.github.com/user";var Be=require("express");var De=require("express");var v=require("class-transformer"),d=require("typeorm");var f=require("typeorm");var y=require("typeorm");var g=class{};c([(0,y.PrimaryGeneratedColumn)()],g.prototype,"id",2),c([(0,y.Column)({type:"varchar",nullable:!1})],g.prototype,"name",2),c([(0,y.ManyToOne)(()=>l,r=>r.files,{cascade:!0})],g.prototype,"link",2),g=c([(0,y.Entity)({name:"files"})],g);var l=class{};c([(0,f.PrimaryGeneratedColumn)()],l.prototype,"id",2),c([(0,f.Column)({type:"varchar",nullable:!1,unique:!0})],l.prototype,"href",2),c([(0,f.ManyToOne)(()=>p,r=>r.links,{cascade:!0})],l.prototype,"user",2),c([(0,f.OneToMany)(()=>g,r=>r.link)],l.prototype,"files",2),l=c([(0,f.Entity)({name:"links"})],l);var p=class{toJSON(){return(0,v.classToPlain)(this)}};c([(0,d.PrimaryGeneratedColumn)()],p.prototype,"id",2),c([(0,d.Column)({type:"varchar",nullable:!1})],p.prototype,"name",2),c([(0,d.Column)({type:"varchar",nullable:!0,unique:!0})],p.prototype,"email",2),c([(0,v.Exclude)(),(0,d.Column)({type:"varchar",nullable:!0})],p.prototype,"password",2),c([(0,v.Exclude)(),(0,d.Column)({type:"varchar",nullable:!0,unique:!0})],p.prototype,"google_id",2),c([(0,v.Exclude)(),(0,d.Column)({type:"varchar",nullable:!0,unique:!0})],p.prototype,"github_id",2),c([(0,d.OneToMany)(()=>l,r=>r.user)],p.prototype,"links",2),p=c([(0,d.Entity)({name:"users"})],p);var X=_(require("bcrypt")),P=_(require("jsonwebtoken"));var Ie=require("redis");var ve=(0,Ie.createClient)({url:ge});ve.on("error",r=>console.log("Redis Client Error",r));var h=ve;var Q=class{constructor(){this.generateTokens=(e,t)=>n(this,null,function*(){let o=P.default.sign(e,M,{expiresIn:he*60*60}),s=P.default.sign(t,z,{expiresIn:S*60*60});return yield this.saveToken(s,S*60),{accessToken:o,refreshToken:s}});this.saveToken=(e,t)=>n(this,null,function*(){yield h.connect(),yield h.set(e,"token",{EX:t}),yield h.disconnect()});this.removeToken=e=>n(this,null,function*(){yield h.connect(),yield h.del(e),yield h.disconnect()});this.tokenDecode=(e,t=!1)=>n(this,null,function*(){let o=null;try{o=P.default.verify(e,t?z:M)}catch(s){yield h.del(e)}return o});this.isTokenExists=e=>n(this,null,function*(){yield h.connect();let t=yield h.exists(e);return yield h.disconnect(),!!t});this.hashPass=e=>n(this,null,function*(){return X.default.hash(e,7)});this.comparePass=(e,t)=>n(this,null,function*(){return X.default.compare(e,t)})}},b=Q;var V=class{constructor(){this.generateUrl=e=>n(this,null,function*(){let t=new URLSearchParams({client_id:$,redirect_uri:K,scope:L.join(" "),state:e||""});return`${Re}?${t}`});this.getToken=e=>n(this,null,function*(){let t=new URLSearchParams({client_id:$,client_secret:ye,redirect_uri:K,code:e});return yield(yield fetch(`${Te}?${t}`,{method:"post",headers:{Accept:"application/json"}})).json()});this.getUserInfo=e=>n(this,null,function*(){return yield(yield fetch(`${Oe}`,{headers:{Authorization:`Bearer ${e}`}})).json()})}},we=V;var Y=class{constructor(){this.generateUrl=e=>n(this,null,function*(){let t=new URLSearchParams({client_id:q,redirect_uri:J,response_type:"code",scope:L.join(" "),access_type:"offline",state:e||""});return`${Ee}?${t}`});this.getToken=e=>n(this,null,function*(){return yield(yield fetch(_e,{method:"post",body:JSON.stringify({client_id:q,client_secret:fe,code:e,grant_type:"authorization_code",redirect_uri:J})})).json()});this.getUserInfo=e=>n(this,null,function*(){return yield(yield fetch(`${Se}?access_token=${e}`,{method:"get"})).json()})}},Ue=Y;var ke=require("typeorm");var Ve=F&&C&&W&&H&&A?{type:"postgres",host:F,port:W,username:H,password:A,database:C}:{type:"sqlite",database:`${C}.sqlite3`},Ge=new ke.DataSource(I(O({},Ve),{entities:[g,l,p],synchronize:!0,logging:de}));Ge.initialize().then(()=>{console.log("Data Source has been initialized!")}).catch(r=>{console.error("Error during Data Source initialization",r)});var xe=Ge;var Z=class{constructor(e){this.getOne=e=>n(this,null,function*(){return this.modelRepository.findOne({where:e})});this.getMany=e=>n(this,null,function*(){return this.modelRepository.find({where:e})});this.create=e=>n(this,null,function*(){let t=this.modelRepository.create(e);return this.modelRepository.save(t)});this.update=e=>n(this,null,function*(){return this.modelRepository.save(e)});this.delete=e=>n(this,null,function*(){return this.modelRepository.delete(e)});this.getOrUpdate=(e,t)=>n(this,null,function*(){let o=yield this.getOne(e);return o?this.update(I(O({},t),{id:o.id})):this.create(t)});this.modelRepository=xe.getRepository(e)}},N=Z;var ee=class{constructor(){this.userService=new N(p);this.authService=new b;this.googleService=new Ue;this.githubService=new we;this.login=(e,t)=>n(this,null,function*(){let{email:o,password:s}=e.body,i=yield this.userService.getOne({email:o});if(!i)return t.status(401).json({error:"User not found"});if(!(yield this.authService.comparePass(s,i.password)))return t.status(401).json({error:"Wrong password"});let{accessToken:m,refreshToken:a}=yield this.authService.generateTokens({id:i.id},{id:i.id});return t.cookie("refreshToken",a,{maxAge:S*60*1e3,httpOnly:!0,sameSite:"none",secure:!0}).json({user:i,accessToken:m})});this.register=(e,t)=>n(this,null,function*(){let{email:o,name:s,password:i}=e.body;if(yield this.userService.getOne({email:o}))return t.status(401).json({error:"User already exists"});let m=yield this.authService.hashPass(i),a=yield this.userService.create({name:s,email:o,password:m}),{accessToken:E,refreshToken:U}=yield this.authService.generateTokens({id:a.id},{id:a.id});return t.cookie("refreshToken",U,{maxAge:S*60*1e3,httpOnly:!0,sameSite:"none",secure:!0}).json({user:a,accessToken:E})});this.oauth=(e,t)=>n(this,null,function*(){let i=yield(e.path==="/google"?this.googleService:this.githubService).generateUrl(e.query.state||"");return t.redirect(i)});this.redirect=(e,t)=>n(this,null,function*(){let o=e.path==="/google/redirect",s=o?this.googleService:this.githubService,{error:i,code:u,state:m}=e.query,a=null;if(i&&(a=e.query),!a){let E=yield s.getToken(u);if(E.error&&(a=E),!a){let U=yield s.getUserInfo(E.access_token);if(U.error&&(a=U),!a){let{id:x,name:ie}=U,k=yield this.userService.getOne(o?{google_id:x}:{github_id:x});k||(k=yield this.userService.create(o?{name:ie,google_id:x}:{name:ie,github_id:x}));let{accessToken:Fe,refreshToken:Me}=yield this.authService.generateTokens({id:k.id},{id:k.id});a={user:k,accessToken:Fe},t.cookie("refreshToken",Me,{maxAge:S*60*1e3,httpOnly:!0,sameSite:"none",secure:!0})}}}return m?t.redirect(m+"#"+JSON.stringify(a)):(a.error&&t.status(401),t.json(a))});this.refresh=(e,t)=>n(this,null,function*(){let o=e.cookies.refreshToken;if(console.log(o),!o)return t.status(401).json({error:"Unauthorized"});if(!(yield this.authService.isTokenExists(o)))return t.status(401).json({error:"Unauthorized"});let s=yield this.authService.tokenDecode(o,!0);if(yield this.authService.removeToken(o),!s)return t.status(401).json({error:"Unauthorized"});let i=yield this.userService.getOne({id:s.id});if(!i)return t.status(401).json({error:"Unauthorized"});let{accessToken:u,refreshToken:m}=yield this.authService.generateTokens({id:i.id},{id:i.id});return t.cookie("refreshToken",m,{maxAge:S*60*1e3,sameSite:"none",secure:!0}).json({user:i,accessToken:u})})}},R=new ee;var T=(0,De.Router)();T.get("/google",R.oauth);T.get("/github",R.oauth);T.get("/google/redirect",R.redirect);T.get("/github/redirect",R.redirect);T.post("/login",R.login);T.post("/register",R.register);T.get("/refresh",R.refresh);var Ce=T;var Le=require("express");var w=(r,e,t)=>n(void 0,null,function*(){let o=new b,s=r.headers.authorization;if(!s)return e.status(401).json({error:"Unauthorized"});let i=s.split(" ");if(i.length!==2)return e.status(401).json({error:"Unauthorized"});let u=yield o.tokenDecode(i[1]);return u.err&&console.log(u.err),e.status(401).json({error:"Unauthorized"})});var te=(0,Le.Router)();te.post("/",w);te.delete("/",w);var Pe=te;var be=require("express");var re=class{constructor(){this.linkService=new N(l);this.create=(e,t)=>n(this,null,function*(){let{href:o}=e.body;if(yield this.linkService.getOne({href:o}))return t.json({error:"Link already exists"});let i=yield this.linkService.create({href:o});return t.json({link:i})});this.update=(e,t)=>n(this,null,function*(){let{id:o,href:s}=e.body;if(yield this.linkService.getOne({href:s}))return t.json({error:"Link already exists"});let u=yield this.linkService.getOne({id:o});return u?(u=yield this.linkService.update(I(O({},u),{href:s})),t.json({link:u})):t.json({error:"Link not found"})});this.delete=(e,t)=>n(this,null,function*(){let{id:o}=e.body;return yield this.linkService.delete({id:o}),t.json({message:"Success"})})}},oe=new re;var se=(0,be.Router)();se.post("/",w,oe.create);se.delete("/",w,oe.delete);var Ne=se;var B=(0,Be.Router)();B.use("/auth",Ce);B.use("/files",Pe);B.use("/links",Ne);var je=B;var G=(0,ne.default)();G.use((0,He.default)());G.use(ne.default.json());G.use((0,Ae.default)({origin:["https://webshining.client.com","https://localhost:3000","http://localhost:3000"],credentials:!0}));G.use("/api",je);var Ye=We.default.createServer(G),Ze=()=>n(exports,null,function*(){Ye.listen(j,()=>console.log(`Server running on port ${j}`))});Ze();
//# sourceMappingURL=bundle.js.map
